#!/usr/bin/env bash
# exit on error
set -o errexit

echo "ğŸ“¦ Installing dependencies..."
bundle install

echo "ğŸ—„ï¸  Checking database connection..."
echo "DEBUG: DATABASE_URL is set: $([ -z "$DATABASE_URL" ] && echo 'NO' || echo 'YES')"
if [ -n "$DATABASE_URL" ]; then
  # Show more of the URL to see hostname and port (sanitize password)
  SANITIZED_URL=$(echo "$DATABASE_URL" | sed -E 's/(:\/\/[^:]+:)[^@]+(@)/\1***\2/')
  echo "DEBUG: DATABASE_URL = $SANITIZED_URL"
fi

if [ -z "$DATABASE_URL" ]; then
  echo "âš ï¸  DATABASE_URL not set, skipping migrations"
  echo "âš ï¸  Please set DATABASE_URL environment variable in Render"
else
  # Test database connection directly
  echo "ğŸ”Œ Testing database connection..."
  if psql "$DATABASE_URL" -c "SELECT 1;" > /dev/null 2>&1; then
    echo "âœ… Database connection successful!"
  else
    echo "âš ï¸  Cannot connect to database directly"
    echo "âš ï¸  This might be a network/firewall issue on Render"
  fi

  # Temporarily disable errexit for migration attempt
  set +e
  echo "ğŸ—„ï¸  Running database migrations..."
  bundle exec rails db:migrate
  migration_status=$?
  set -e

  if [ $migration_status -eq 0 ]; then
    echo "âœ… Migrations completed successfully"
  else
    echo "âš ï¸  Migrations failed - database may not be ready yet"
    echo "âš ï¸  Continuing build anyway. You can run migrations manually later."
  fi
fi

echo "âœ… Build complete!"
