#!/usr/bin/env bash
# exit on error
set -o errexit

echo "üì¶ Installing dependencies..."
bundle install

echo "üóÑÔ∏è  Checking database connection..."
echo "DEBUG: DATABASE_URL is set: $([ -z "$DATABASE_URL" ] && echo 'NO' || echo 'YES')"
if [ -n "$DATABASE_URL" ]; then
  echo "DEBUG: DATABASE_URL format: ${DATABASE_URL:0:30}... (showing first 30 chars)"
fi

if [ -z "$DATABASE_URL" ]; then
  echo "‚ö†Ô∏è  DATABASE_URL not set, skipping migrations"
  echo "‚ö†Ô∏è  Please set DATABASE_URL environment variable in Render"
else
  # Temporarily disable errexit for migration attempt
  set +e
  echo "üóÑÔ∏è  Running database migrations..."
  bundle exec rails db:migrate
  migration_status=$?
  set -e

  if [ $migration_status -eq 0 ]; then
    echo "‚úÖ Migrations completed successfully"
  else
    echo "‚ö†Ô∏è  Migrations failed - database may not be ready yet"
    echo "‚ö†Ô∏è  Continuing build anyway. You can run migrations manually later."
  fi
fi

echo "‚úÖ Build complete!"
